@page "/atleta"
@inherits Microsoft.AspNetCore.Components.ComponentBase
@rendermode InteractiveServer
<h3>Registro de Atleta</h3>
<p role="status">Numero: @currentCount</p>

<div class="card p-3 shadow-sm mt-3">
    <EditForm Model="@atleta" OnValidSubmit="@GuardarAtleta">
        <DataAnnotationsValidator />
        <ValidationSummary />

               <div class="mb-3">
            <label>Nombre:</label>
            <InputText @bind-Value="atleta.Nombre" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Edad:</label>
            <InputNumber TValue="int" @bind-Value="atleta.Edad" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Discapacidades:</label>
            <InputText @bind-Value="nuevaDiscapacidad" class="form-control" placeholder="Agregar una discapacidad" />
            <button type="button" class="btn btn-secondary mt-2" @onclick="AgregarDiscapacidad">Agregar</button>

            <ul class="list-group mt-2">
                @if (atleta.Discapacidades?.Count > 0)
                {
                    @foreach (var d in atleta.Discapacidades)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            @d
                            <button type="button" class="btn btn-sm btn-danger" @onclick="@(() => QuitarDiscapacidad(d))">X</button>
                        </li>
                    }
                }
            </ul>
        </div>
        
        <button type="submit" class="btn btn-primary">Guardar</button>
    </EditForm>
</div>

@code {
    private ProyectoPuntoNET.Models.Atleta atleta = new ProyectoPuntoNET.Models.Atleta();
    private string nuevaDiscapacidad = string.Empty;

    private void AgregarDiscapacidad()
    {
        atleta.Discapacidades ??= new List<string>();
        if (!string.IsNullOrWhiteSpace(nuevaDiscapacidad))
        {
            atleta.Discapacidades.Add(nuevaDiscapacidad.Trim());
            nuevaDiscapacidad = string.Empty;
        }
    }

    private void QuitarDiscapacidad(string discapacidad)
    {
        atleta.Discapacidades?.Remove(discapacidad);
    }
    // Variable única y segura para concurrencia
    private static int currentCount = 1;

    private void GuardarAtleta()
    {
        // Incremento atómico y usamos directamente currentCount
        System.Threading.Interlocked.Increment(ref currentCount);

        Console.WriteLine($"Atleta guardado: {atleta.Nombre}, Edad: {atleta.Edad}, Discapacidades: {string.Join(", ", atleta.Discapacidades ?? new List<string>())}, Número: {currentCount}");
        // Limpiar formulario
        atleta = new ProyectoPuntoNET.Models.Atleta(); // Reinicia el objeto atleta
        nuevaDiscapacidad = string.Empty;             // Limpia el campo de nueva discapacidad
    }

}

