@page "/atleta"
@using Microsoft.AspNetCore.Components.Forms
@using ProyectoPuntoNET.Data
@inject AppDbContext Context

<h3>Registro de Atleta</h3>
<p role="status">Número: @currentCount</p>

<div class="card p-3 shadow-sm mt-3">
    <EditForm Model="@atleta" OnValidSubmit="@GuardarAtleta">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Nombre:</label>
            <InputText @bind-Value="atleta.Nombre" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Edad:</label>
            <InputNumber TValue="int" @bind-Value="atleta.Edad" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Discapacidades:</label>
            <InputText @bind-Value="nuevaDiscapacidad" class="form-control" placeholder="Agregar una discapacidad" />
            <button type="button" class="btn btn-secondary mt-2" @onclick="AgregarDiscapacidad">Agregar</button>

            <ul class="list-group mt-2">
                @if (atleta.Discapacidades?.Count > 0)
                {
                    @foreach (var d in atleta.Discapacidades)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            @d
                            <button type="button" class="btn btn-sm btn-danger" @onclick="@(() => QuitarDiscapacidad(d))">X</button>
                        </li>
                    }
                }
            </ul>
        </div>
        
        <button type="submit" class="btn btn-primary">Guardar</button>
    </EditForm>
</div>
@code {
    private ProyectoPuntoNET.Data.Atleta atleta = new ProyectoPuntoNET.Data.Atleta
    {
        Discapacidades = new List<string>()
    };
    private string nuevaDiscapacidad = string.Empty;

    private void AgregarDiscapacidad()
    {
        if (!string.IsNullOrWhiteSpace(nuevaDiscapacidad))
        {
            atleta.Discapacidades.Add(nuevaDiscapacidad.Trim());
            nuevaDiscapacidad = string.Empty;
        }
    }

    private void QuitarDiscapacidad(string discapacidad)
    {
        atleta.Discapacidades.Remove(discapacidad);
    }
    private static int currentCount = 1;
    private async Task GuardarAtleta()
    {
        try
        {
            // Agregar el atleta al DbContext
            Context.Atletas.Add(atleta);

            // Guardar cambios en la base de datos
            await Context.SaveChangesAsync();

            // Ahora atleta.Numero tiene el valor autogenerado por la base de datos
            Console.WriteLine($"Atleta guardado: {atleta.Nombre}, Edad: {atleta.Edad}, Número: {atleta.Numero}");
            currentCount = atleta.Numero;
            // Limpiar el formulario para un nuevo registro
            atleta = new ProyectoPuntoNET.Data.Atleta();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al guardar atleta: {ex.Message}");
        }
    }
}

